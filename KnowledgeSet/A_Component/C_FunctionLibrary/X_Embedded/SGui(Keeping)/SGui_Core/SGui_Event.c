#include "SGui_Kernel.h"
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
/* 实现目标:
 * 设计简要的事件管理方案
 * 用于传递事件以及事件携带的数据
 */
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
typedef struct SimpleGui_Event {
    void    *Next;
    uint8_t *Parameter2;
    uint32_t Parameter1;
    uint32_t EventType;
} SGui_Event;
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
typedef struct SimpleGui_EventSet {
    SGui_Event *Head;
    SGui_Event *Tail;
} SGui_EventSet;
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
static SGui_EventSet EventSet = {.Head = NULL, .Tail = NULL};
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
static void (*EventSyncLock)(void)   = NULL;
static void (*EventSyncUnlock)(void) = NULL;
static void (*EventSyncNotify)(void) = NULL;
static void (*EventSyncWait)(void)   = NULL;
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
bool SGui_EventSetIsEmpty(void)
{
    if (EventSet.Head != NULL || EventSet.Tail != NULL)
        return false;
    return true;
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void SGui_EventEnqueue(uint32_t EventType, uint32_t Parameter1, uint8_t *Parameter2)
{
    if (EventSyncLock != NULL)
        EventSyncLock();
    
    /* 1.生成事件记录 */
    SGui_Event *Event = SGUI_ALLOC(sizeof(SGui_Event));
    /* 2.记录事件 */    
    Event->Next       = NULL;
    Event->EventType  = EventType;
    Event->Parameter1 = Parameter1;
    Event->Parameter2 = Parameter2;
    /* 3.事件入队列 */
    if (EventSet.Tail != NULL) {
        EventSet.Tail->Next = Event;
        EventSet.Tail = Event;
    }
    if (EventSet.Tail == NULL) {
        EventSet.Head = Event;
        EventSet.Tail = Event;
    }
    
    if (EventSyncUnlock != NULL)
        EventSyncUnlock();
    if (EventSyncNotify != NULL)
        EventSyncNotify();
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void SGui_EventDequeue(uint32_t *EventType, uint32_t *Parameter1, uint8_t **Parameter2)
{
    if (EventSyncLock != NULL)
        EventSyncLock();
    
    /* 1.生成事件记录 */
    SGui_Event *Event = EventSet.Head;
    /* 2.事件出队列 */
    if (EventSet.Head != NULL)
        EventSet.Head = Event->Next;
    if (EventSet.Head == NULL) {
        EventSet.Head = NULL;
        EventSet.Tail = NULL;
    }
    /* 3.提取事件 */
    if (Event == NULL)
        *EventType = SGUI_EVENT_INVALID;
    if (Event != NULL) {
        *EventType  = Event->EventType;
        *Parameter1 = Event->Parameter1;
        *Parameter2 = Event->Parameter2;
         /* 移除事件记录 */
        SGUI_FREE(Event);
    }
    
    if (EventSyncUnlock != NULL)
        EventSyncUnlock();
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void SGui_EventSync(void)
{
    if (EventSyncWait != NULL)
        EventSyncWait();
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void SGui_EventSyncRegister(void (*Lock)(void), void (*Unlock)(void),
                            void (*Notify)(void), void (*Wait)(void))
{
    EventSyncLock   = Lock;
    EventSyncUnlock = Unlock;
    EventSyncNotify = Notify;
    EventSyncWait   = Wait;
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
#if SGUI_INTERNAL_TEST
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void SGui_Event_Test(void)
{
    uint32_t Event1   = 1;
    uint32_t Length1  = 7;
    uint8_t  Data1[7] = "Event1";

    uint32_t Event2   = 2;
    uint32_t Length2  = 7;
    uint8_t  Data2[7] = "Event2";
    
    uint32_t Event3   = 3;
    uint32_t Length3  = 7;
    uint8_t  Data3[7] = "Event3";

    SGui_EventEnqueue(Event2, Length2, Data2);
    SGui_EventEnqueue(Event1, Length1, Data1);
    SGui_EventEnqueue(Event3, Length3, Data3);
    
    uint32_t EventType  = 0;
    uint32_t Length = 0;
    uint8_t *Data   = NULL;
    
    while (SGui_EventSetIsEmpty() == false) {
        
        SGui_EventDequeue(&EventType, &Length, &Data);
        SGUI_LOGMESSAGE("EventType:%d,Length:%d,Data:%s", EventType, Length, Data);
    }
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
#endif
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
