#include <string.h>
#include "SGui_Kernel.h"
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
/* 实现目标:
 * 设计简要的控件绘制引擎
 * 用于进行基本绘制工作及其流程
 */
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/

/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
/* 这个状态量可以设置平台信号量替换 */
/* 因为这只是想象中的可能有效,实际上解决不了并发冲突 */
static bool SGui_EngineRunStatus   = false;
static bool SGui_EngineAbortStatus = false;
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
static bool SGui_EngineIsAbort(void)
{
    return SGui_EngineAbortStatus;
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
static void SGui_EngineIntoRun(void)
{
    SGui_EngineRunStatus   = true;
    SGui_EngineAbortStatus = false;
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
static void SGui_EngineExitRun(void)
{
    SGui_EngineRunStatus   = false;
    SGui_EngineAbortStatus = false;
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
bool SGui_EngineWaitReady(bool Wait)
{
    if (Wait == true)
        while (SGui_EngineRunStatus == true);
    
    return SGui_EngineRunStatus == true ? false : true;
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void SGui_EngineAbort(void)
{
    SGui_EngineAbortStatus = true;
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void SGui_EngineRun(void)
{
    SGui_EngineRunStatus = true;
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void SGui_EngineExecuteTask(void *Pointer)
{
    /* 初始化动画及其定时器 */
    SGui_AnimationRegister(SGui_AnimationAdaptorEventDispatch);
    SGui_TimerConfigure(SGui_AnimationMSHandler);
    SGui_TimerInit();
    /* 等待事件的到来 */
    while (1) {
        /* 引擎仅仅在UI交互后执行 */
        SGui_EngineWaitReady(true);
        
        
        SGui_EngineIntoRun();
        /* 派发UI事件交付到控件进行执行 */
        while (SGui_EventSetIsEmpty() == false) {
            /* 首要检查,如果外界要强行中止引擎 */
            if (SGui_EngineIsAbort() == true) {
                SGui_EngineExitRun();
                break;
            }
            /* 处理引擎产生的事件 */
            uint32_t Event  = SGUI_EVENT_INVALID;
            uint32_t Length = 0;
            uint8_t *Data   = NULL;
            /* 取出引擎产生的事件 */
            SGui_EventDequeue(&Event, &Length, &Data);
            /* 通配事件派发到控件 */
            switch (Event) {
            
            /* 动画事件 */
            case SGui_EventType_Animation:
                SGui_AnimationAdaptorEventExecute(Length, Data);
                break;
            /* .... */
            default: break;    
            }
        }
        
        SGui_EngineExitRun();
    }
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
