/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
//C std lib
#include <stddef.h>
#include <stdint.h>
#include <stdbool.h>
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
#define LOG_PART_STATUS     0   /* 1:ENABLE,0:DISABLE */
#define LOG_PART_LEVEL      0   /* 0:DEBUG,1:INFO,2:WARN,3:ERROR,4:NONE */
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
#include "LogMessage.h"
#include "PriorityQueue.h"
#include "CriticalZone.h"
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
#include "MiniOS_Memory.h"
#include "MiniOS_Task.h"
#include "MiniOS_Timer.h"
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
typedef struct MiniOS_TaskControlBlock {
    void   (*Handler)(uint32_t Event);  /* 任务体 */
    uint8_t  Priority;                  /* 任务优先级 */
    PQ_Node  TaskNode;                  /* 优先队列任务关联 */
    uint32_t Event;                     /* 事件 */
} MiniOS_TCB;
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
static PQ_Body TaskExecuteQueue = {0};
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
static bool MiniOS_TCB_Compare(PQ_Node *Node1, PQ_Node *Node2)
{
    uint8_t Priority1 = (PQ_GetOwner(MiniOS_TCB, TaskNode, Node1))->Priority;
    uint8_t Priority2 = (PQ_GetOwner(MiniOS_TCB, TaskNode, Node2))->Priority;
    
    return (Priority1 < Priority2) ? true : false;
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void MiniOS_TaskReady(void)
{
    LOG_WARN(true, "MiniOS_TaskReady");
    PQ_ResetQueue(&TaskExecuteQueue);
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void MiniOS_TaskExecute(void)
{
    while (1) {
        PQ_Node *Node = NULL;
        MiniOS_TCB *TCB = NULL;
        
        CriticalZoneEnter(TaskLock);
        Node = PQ_GetHead(&TaskExecuteQueue);
        if (Node != NULL) {
            LOG_WARN(true, "MiniOS_TaskExecute");
            TCB = PQ_GetOwner(MiniOS_TCB, TaskNode, Node);
            PQ_DeQueue(&TaskExecuteQueue, &(TCB->TaskNode));
        }
        CriticalZoneExit(TaskLock);
        
        if (TCB != NULL && TCB->Handler != NULL)
            TCB->Handler(TCB->Event);
        
        /* 下面可以挂低功耗,CPU除了RTC其他都可以关闭 */
        static uint32_t IdleCount = 0;
        if (TCB == NULL) {
            IdleCount++;
            if (IdleCount > 10000) {
                /* 此处可进入休眠,因为很久没来事件了 */
                IdleCount = 0;
            }
        }
    }
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
MiniOS_TaskHandle MiniOS_TaskCreate(void (*Handler)(uint32_t Event), uint8_t Priority)
{
    LOG_WARN(true, "MiniOS_TaskCreate");
    MiniOS_TCB *TCB = MiniOS_Alloc(sizeof(MiniOS_TCB));
    
    if (TCB != NULL) {
        TCB->Handler  = Handler;
        TCB->Priority = Priority;
        TCB->Event    = 0;
        PQ_ResetNode(&(TCB->TaskNode));
    }
    
    return TCB;
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void MiniOS_TaskDestroy(MiniOS_TaskHandle Handle)
{
    MiniOS_TCB *TCB = Handle;
    LOG_WARN(true, "MiniOS_TaskDestroy");
    CriticalZoneEnter(TaskLock);
    PQ_DeQueue(&TaskExecuteQueue, &(TCB->TaskNode));
    CriticalZoneExit(TaskLock);
    MiniOS_Free(TCB);
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void MiniOS_TaskToggle(MiniOS_TaskHandle Handle, uint32_t Event)
{
    MiniOS_TCB *TCB = Handle;
    TCB->Event = Event;
    LOG_WARN(true, "MiniOS_TaskToggle");
    CriticalZoneEnter(TaskLock);
    PQ_DeQueue(&TaskExecuteQueue, &(TCB->TaskNode));
    PQ_EnQueue(&TaskExecuteQueue, &(TCB->TaskNode), MiniOS_TCB_Compare);
    CriticalZoneExit(TaskLock);
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
