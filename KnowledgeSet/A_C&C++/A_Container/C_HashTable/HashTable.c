#include <stdint.h>
#include <stdbool.h>
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
#include "List.h"
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
typedef struct HashTable_Node {
    SL_Node Node;
} HT_Node;
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
typedef struct HashTable_Nodes {
    SL_List Head;
    SL_List Tail;
} HT_Nodes;
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
typedef struct HashTable_Table {
    HT_Nodes  *Array;
    uint32_t (*HashFunction)(HT_Node *Node);
    bool     (*IsEqual)(HT_Node *Node1, HT_Node *Node2);
    uint32_t   Length;
} HT_Table;
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
typedef uint32_t (*HT_HashFunction)(HT_Node *Node);
typedef bool     (*HT_IsEqual)(HT_Node *Node1, HT_Node *Node2);
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void HT_Table_SetZone(HT_Table *Table, HT_Nodes *Array, uint32_t Length)
{
    Table->Array  = Array;
    Table->Length = Length;
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void HT_Table_Set(HT_Table *Table, HT_HashFunction HashFunction, HT_IsEqual IsEqual)
{
    Table->HashFunction = HashFunction;
    Table->IsEqual      = IsEqual;
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void HT_Node_Add(HT_Table *Table, HT_Node *Node)
{
    /* 散列 */
    uint32_t Index = Table->HashFunction(Node) % Table->Length;
    /* 得到节点链表 */
    SL_List *Head = &((Table->Array[Index]).Head);
    SL_List *Tail = &((Table->Array[Index]).Tail);
    /* 追加 */
    SL_List_Append(Head, Tail, &(Node->Node));
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
void HT_Node_Remove(HT_Table *Table, HT_Node *Node)
{
    /* 散列 */
    uint32_t Index = Table->HashFunction(Node) % Table->Length;
    /* 得到节点链表 */
    SL_List *Head = &((Table->Array[Index]).Head);
    SL_List *Tail = &((Table->Array[Index]).Tail);
    /* 迭代该节点找到前一项 */
    if (SL_List_GetHead(Head) == &(Node->Node)) {
        SL_List_Remove(Head, Tail, NULL, &(Node->Node));
        return;
    }
    /* 迭代该节点找到前一项 */
    SL_List_Traserve(Head, Tail, Current) {
        SL_Node *Near = SL_Node_GetNear(Current);
        if (Near == NULL)
            return;
        HT_Node *Target = List_GetOwner(HT_Node, Node, Near);
        if (Target == Node) {
            SL_List_Remove(Head, Tail, Current, &(Node->Node));
            return;
        }
    }
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
HT_Node * HT_Node_Search(HT_Table *Table, HT_Node *Node)
{
    /* 散列 */
    uint32_t Index = Table->HashFunction(Node) % Table->Length;
    /* 得到节点链表 */
    SL_List *Head = &((Table->Array[Index]).Head);
    SL_List *Tail = &((Table->Array[Index]).Tail);
    /* 迭代该节点找到第一个匹配者 */
    SL_List_Traserve(Head, Tail, Current) {
        HT_Node *Target = List_GetOwner(HT_Node, Node, Current);
        if (Table->IsEqual(Target, Node) == true)
            return Target;
    }
    return NULL;
}
/*************************************************************************************************/
/*************************************************************************************************/
/*************************************************************************************************/
